<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–µ –≤–µ–±‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>

  <!-- ‚ñë‚ñë Pico¬†CSS¬†‚Äî –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ JS ‚ñë‚ñë -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@picocss/pico@1.5.10/css/pico.min.css">

  <!-- ‚ñë‚ñë –ù–µ–±–æ–ª—å—à–∞—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –¥–ª—è –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é ‚ñë‚ñë -->
  <style>
    body { display:flex; flex-direction:column; height:100vh; }
    header { flex:0 0 auto; }
    main   { flex:1 1 auto; overflow:auto; padding:1.5rem; }
    nav#sidebar {
      width: 220px; min-height:100%;
      border-right:1px solid var(--pico-border-color);
      padding:1rem; position:sticky; top:0;
    }
    nav ul { list-style:none; padding:0; }
    nav li + li { margin-top: .25rem; }
    nav button { width:100%; text-align:left; }
    /* –ª—ë–≥–∫–∞—è —Ç–µ–Ω—å —à–∞–ø–∫–∏ */
    header { box-shadow:0 2px 4px rgb(0 0 0 / .08); }
  </style>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- ‚ñà –®–∞–ø–∫–∞ ‚ñà -->
  <header class="container-fluid">
    <hgroup>
      <h1 style="margin-bottom:0">–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã</h1>
      <small>–¥–µ–º–æ –Ω–∞ Supabase¬†+¬†Pico¬†CSS</small>
    </hgroup>

    <div id="user-info" hidden>
      <span id="username"></span>
      <button id="logout-btn" class="secondary">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <div style="display:flex; flex:1 1 auto;">
    <!-- ‚ñë –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é ‚ñë -->
    <nav id="sidebar" hidden>
      <ul>
        <li><button data-service="1">üõ†Ô∏è¬†–ü–æ–¥–±–æ—Ä –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</button></li>
        <li><button data-service="2">üìÑ¬†–°–µ—Ä–≤–∏—Å¬†2¬†(—Å–∫–æ—Ä–æ)</button></li>
        <li><button data-service="3">üìä¬†–°–µ—Ä–≤–∏—Å¬†3¬†(—Å–∫–æ—Ä–æ)</button></li>
      </ul>
    </nav>

    <!-- ‚ñë –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç ‚ñë -->
    <main id="content" class="container-fluid"></main>
  </div>

  <!-- ‚ñà –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–æ–≥–∏–Ω–∞ ‚ñà -->
  <dialog id="auth-modal" open>
    <article style="max-width:420px">
      <header><strong>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</strong></header>

      <!-- —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
      <form id="signup-form">
        <h5>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h5>
        <input id="su-email" type="email" placeholder="E‚Äëmail" required>
        <input id="su-pass"  type="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
        <input id="su-name"  type="text" placeholder="–ò–º—è" required>
        <button class="contrast">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
      </form>

      <hr>

      <!-- –≤—Ö–æ–¥ -->
      <form id="login-form">
        <h5>–í—Ö–æ–¥</h5>
        <input id="li-email" type="email" placeholder="E‚Äëmail" required>
        <input id="li-pass"  type="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
        <button class="contrast">–í–æ–π—Ç–∏</button>
      </form>
    </article>
  </dialog>

  <!-- ‚ñà –°–∫—Ä–∏–ø—Ç¬†(—Ç–æ—Ç –∂–µ, —Ç–æ–ª—å–∫–æ –±–µ–∑ Tailwind) ‚ñà -->
  <script type="module">
    /*‚Äì‚Äì –∫–æ–Ω—Ñ–∏–≥ ‚Äì‚Äì*/
    const SUPABASE_URL = 'https://uuzsujqizwkqhwijrszr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1enN1anFpendrcWh3aWpyc3pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5OTkzMDMsImV4cCI6MjA2MzU3NTMwM30.g9OD47l7kTVvK628mffBNwcX6gZXMiM8MoAK5uq0gBo';
    const OPENAI_KEY   = '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';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    window.sb = supabase;   window.OPENAI_KEY = OPENAI_KEY;

    /*‚Äì‚Äì DOM ‚Äì‚Äì*/
    const dlgAuth = document.getElementById('auth-modal');
    const sidebar = document.getElementById('sidebar');
    const userBox = document.getElementById('user-info');
    const usernameLbl = document.getElementById('username');

    /*‚Äì‚Äì helpers ‚Äì‚Äì*/
    export async function refreshBalance() {
      const uid = (await supabase.auth.getUser()).data.user.id;
      const { data } = await supabase
        .from('profiles')
        .select('username,balance')
        .eq('id', uid)
        .maybeSingle();
      usernameLbl.textContent = `${data?.username || '–ü—Ä–æ—Ñ–∏–ª—å'} | ‚ÇΩ${data?.balance ?? 0}`;
    }  window.refreshBalance = refreshBalance;

    /*‚Äì‚Äì auth flow ‚Äì‚Äì*/
    async function startApp(){
      dlgAuth.close();            // —Å–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
      sidebar.hidden = false;
      userBox.hidden = false;
      await refreshBalance();
      loadService(1);
    }
    async function checkSession(){
      const { data:{ session }} = await supabase.auth.getSession();
      if(session) startApp();
    }
    checkSession();

    /*‚Äì‚Äì —Ñ–æ—Ä–º—ã ‚Äì‚Äì*/
    document.getElementById('signup-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const { value:email } = suEmail, { value:password } = suPass, { value:name } = suName;
      const { data, error } = await supabase.auth.signUp({
        email, password, options:{ data:{ username:name }}
      });
      if(error) return alert(error.message);
      await supabase.from('profiles').insert({ id:data.user.id, username:name });
      alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –∏ –≤–æ–π–¥–∏—Ç–µ.');
    });

    document.getElementById('login-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const { error } = await supabase.auth.signInWithPassword({
        email: liEmail.value, password: liPass.value
      });
      if(error) return alert(error.message);
      startApp();
    });

    document.getElementById('logout-btn').onclick = async ()=>{
      await supabase.auth.signOut();  location.reload();
    };

    /*‚Äì‚Äì –Ω–∞–≤–∏–≥–∞—Ü–∏—è ‚Äì‚Äì*/
    document.querySelectorAll('.service-btn, nav button')
      .forEach(btn => btn.addEventListener('click', ()=>loadService(btn.dataset.service)));

    async function loadService(n){
      const html = await fetch(`modal${n}.html?ts=${Date.now()}`).then(r=>r.text());
      const container = document.getElementById('content');
      container.innerHTML = html;
      container.querySelectorAll('script').forEach(old=>{
        const s = document.createElement('script');
        [...old.attributes].forEach(a=>s.setAttribute(a.name,a.value));
        s.textContent = old.textContent;  document.body.appendChild(s); old.remove();
      });
      document.dispatchEvent(new CustomEvent('supabase-ready',{ detail:{ supabase }}));
    }
  </script>
</body>
</html>
