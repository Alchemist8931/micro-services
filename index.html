<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ğ¾Ğµ Ğ²ĞµĞ±â€‘Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- â–ˆ  Ğ¨Ğ°Ğ¿ĞºĞ°  â–ˆ -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑÑ‹</h1>
    <div id="user-info" class="hidden">
      <span id="username" class="mr-4"></span>
      <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
    </div>
  </header>

  <!-- â–ˆ  ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚  â–ˆ -->
  <div class="flex flex-1">
    <nav id="sidebar" class="w-56 bg-white border-r p-4 hidden">
      <ul class="space-y-2">
        <li><button data-service="1" class="service-btn w-full text-left px-3 py-2 rounded hover:bg-gray-200">ğŸ› ï¸ ĞŸĞ¾Ğ´Ğ±Ğ¾Ñ€ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</button></li>
        <li><button data-service="2" class="service-btn w-full text-left px-3 py-2 rounded hover:bg-gray-200">ğŸ“„ Ğ¡ĞµÑ€Ğ²Ğ¸ÑÂ 2 (ÑĞºĞ¾Ñ€Ğ¾)</button></li>
        <li><button data-service="3" class="service-btn w-full text-left px-3 py-2 rounded hover:bg-gray-200">ğŸ“Š Ğ¡ĞµÑ€Ğ²Ğ¸ÑÂ 3 (ÑĞºĞ¾Ñ€Ğ¾)</button></li>
      </ul>
    </nav>
    <main id="content" class="flex-1 p-6"></main>
  </div>

  <!-- â–ˆ  Ğ›Ğ¾Ğ³Ğ¸Ğ½/Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ  â–ˆ -->
  <div id="auth-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center">
    <div class="bg-white p-8 rounded shadow w-96">
      <!-- Ñ€ĞµĞ³Ğ° -->
      <form id="signup-form" class="space-y-3">
        <h2 class="text-lg font-semibold">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</h2>
        <input id="su-email"  type="email"    placeholder="Eâ€‘mail"  class="w-full border px-3 py-2" required>
        <input id="su-pass"   type="password" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ"  class="w-full border px-3 py-2" required>
        <input id="su-name"   type="text"     placeholder="Ğ˜Ğ¼Ñ"     class="w-full border px-3 py-2" required>
        <button class="bg-blue-600 text-white w-full py-2 rounded">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</button>
      </form>
      <hr class="my-4">
      <!-- Ğ²Ñ…Ğ¾Ğ´ -->
      <form id="login-form" class="space-y-3">
        <h2 class="text-lg font-semibold">Ğ’Ñ…Ğ¾Ğ´</h2>
        <input id="li-email" type="email"    placeholder="Eâ€‘mail"  class="w-full border px-3 py-2" required>
        <input id="li-pass"  type="password" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ"  class="w-full border px-3 py-2" required>
        <button class="bg-green-600 text-white w-full py-2 rounded">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
      </form>
    </div>
  </div>

  <!-- â–ˆ  Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ  â–ˆ -->
  <script type="module">
    /*â”€â”€ 1. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
    const SUPABASE_URL = 'https://uuzsujqizwkqhwijrszr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1enN1anFpendrcWh3aWpyc3pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5OTkzMDMsImV4cCI6MjA2MzU3NTMwM30.g9OD47l7kTVvK628mffBNwcX6gZXMiM8MoAK5uq0gBo';
    const OPENAI_KEY   = 'sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX';
    window.OPENAI_KEY  = OPENAI_KEY;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /*â”€â”€ 2. DOMâ€‘ĞºĞµÑˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
    const suEmail   = document.getElementById('su-email');
    const suPass    = document.getElementById('su-pass');
    const suName    = document.getElementById('su-name');
    const liEmail   = document.getElementById('li-email');
    const liPass    = document.getElementById('li-pass');
    const logoutBtn = document.getElementById('logout-btn');

    /*â”€â”€ 3. Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
    export async function refreshBalance() {
      const uid = (await supabase.auth.getUser()).data.user.id;
      const { data, error } = await supabase
        .from('profiles').select('username, balance').eq('id', uid).single();
      if (error) { console.error(error); return; }
      document.getElementById('username').textContent =
        `${data.username || 'ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ'} | â‚½${data.balance}`;
    }
    window.refreshBalance = refreshBalance;

    /*â”€â”€ 4. Ğ¡ĞµÑÑĞ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
    async function checkSession() {
      const { data:{ session }} = await supabase.auth.getSession();
      session ? startApp() : document.getElementById('auth-modal').classList.remove('hidden');
    }

    async function startApp() {
      document.getElementById('auth-modal').classList.add('hidden');
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('user-info').classList.remove('hidden');
      await refreshBalance();
      loadService(1);
    }

    /*â”€â”€ 5. Ğ ĞµĞ°ĞºÑ†Ğ¸Ğ¸ Ñ„Ğ¾Ñ€Ğ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
    signupForm.addEventListener('submit', async e => {
      e.preventDefault();
      const { data, error } = await supabase.auth.signUp({
        email: suEmail.value, password: suPass.value,
        options:{ data:{ username: suName.value }}
      });
      if (error) return alert(error.message);
      await supabase.from('profiles').insert({ id:data.user.id, username:suName.value });
      alert('ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ eâ€‘mail Ğ¸ Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ.');
    });

    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      const { error } = await supabase.auth.signInWithPassword({
        email: liEmail.value, password: liPass.value
      });
      if (error) return alert(error.message);
      checkSession();
    });

    logoutBtn.onclick = async () => { await supabase.auth.signOut(); location.reload(); };

    /*â”€â”€ 6. ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
    document.querySelectorAll('.service-btn').forEach(btn =>
      btn.onclick = () => loadService(btn.dataset.service));

    function executeScripts(parent) {
      parent.querySelectorAll('script').forEach(old => {
        const s = document.createElement('script');
        [...old.attributes].forEach(a => s.setAttribute(a.name, a.value));
        s.textContent = old.textContent;
        document.body.appendChild(s); old.remove();
      });
    }

    async function loadService(n) {
      const html = await fetch(`modal${n}.html?ts=${Date.now()}`).then(r => r.text());
      const container = document.getElementById('content');
      container.innerHTML = html;
      executeScripts(container);
      document.dispatchEvent(new CustomEvent('supabase-ready', { detail:{ supabase }}));
    }

    /*â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
    checkSession();
  </script>
</body>
</html>
