<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Микросервисное веб‑приложение</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- █  Шапка  █ -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Микросервисы</h1>
    <div id="user-info" class="hidden">
      <span id="username" class="mr-4"></span>
      <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded">Выйти</button>
    </div>
  </header>

  <!-- █  Контент  █ -->
  <div class="flex flex-1">
    <nav id="sidebar" class="w-56 bg-white border-r p-4 hidden">
      <ul class="space-y-2">
        <li><button data-service="1" class="service-btn w-full text-left px-3 py-2 rounded hover:bg-gray-200">🛠️ Подбор оборудования</button></li>
        <li><button data-service="2" class="service-btn w-full text-left px-3 py-2 rounded hover:bg-gray-200">📄 Сервис 2 (скоро)</button></li>
        <li><button data-service="3" class="service-btn w-full text-left px-3 py-2 rounded hover:bg-gray-200">📊 Сервис 3 (скоро)</button></li>
      </ul>
    </nav>
    <main id="content" class="flex-1 p-6"></main>
  </div>

  <!-- █  Логин/регистрация  █ -->
  <div id="auth-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center">
    <div class="bg-white p-8 rounded shadow w-96">
      <!-- рега -->
      <form id="signup-form" class="space-y-3">
        <h2 class="text-lg font-semibold">Регистрация</h2>
        <input id="su-email"  type="email"    placeholder="E‑mail"  class="w-full border px-3 py-2" required>
        <input id="su-pass"   type="password" placeholder="Пароль"  class="w-full border px-3 py-2" required>
        <input id="su-name"   type="text"     placeholder="Имя"     class="w-full border px-3 py-2" required>
        <button class="bg-blue-600 text-white w-full py-2 rounded">Создать аккаунт</button>
      </form>
      <hr class="my-4">
      <!-- вход -->
      <form id="login-form" class="space-y-3">
        <h2 class="text-lg font-semibold">Вход</h2>
        <input id="li-email" type="email"    placeholder="E‑mail"  class="w-full border px-3 py-2" required>
        <input id="li-pass"  type="password" placeholder="Пароль"  class="w-full border px-3 py-2" required>
        <button class="bg-green-600 text-white w-full py-2 rounded">Войти</button>
      </form>
    </div>
  </div>

  <!-- █  Главный модуль  █ -->
  <script type="module">
    /*── 1. Конфиг ───────────────────────────────────────────────────────*/
    const SUPABASE_URL = 'https://uuzsujqizwkqhwijrszr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1enN1anFpendrcWh3aWpyc3pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5OTkzMDMsImV4cCI6MjA2MzU3NTMwM30.g9OD47l7kTVvK628mffBNwcX6gZXMiM8MoAK5uq0gBo';
    const OPENAI_KEY   = 'sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX';
    window.OPENAI_KEY  = OPENAI_KEY;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /*── 2. DOM‑кеш ──────────────────────────────────────────────────────*/
    const suEmail   = document.getElementById('su-email');
    const suPass    = document.getElementById('su-pass');
    const suName    = document.getElementById('su-name');
    const liEmail   = document.getElementById('li-email');
    const liPass    = document.getElementById('li-pass');
    const logoutBtn = document.getElementById('logout-btn');

    /*── 3. Баланс ──────────────────────────────────────────────────────*/
    export async function refreshBalance() {
      const uid = (await supabase.auth.getUser()).data.user.id;
      const { data, error } = await supabase
        .from('profiles').select('username, balance').eq('id', uid).single();
      if (error) { console.error(error); return; }
      document.getElementById('username').textContent =
        `${data.username || 'Профиль'} | ₽${data.balance}`;
    }
    window.refreshBalance = refreshBalance;

    /*── 4. Сессия ───────────────────────────────────────────────────────*/
    async function checkSession() {
      const { data:{ session }} = await supabase.auth.getSession();
      session ? startApp() : document.getElementById('auth-modal').classList.remove('hidden');
    }

    async function startApp() {
      document.getElementById('auth-modal').classList.add('hidden');
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('user-info').classList.remove('hidden');
      await refreshBalance();
      loadService(1);
    }

    /*── 5. Реакции форм ────────────────────────────────────────────────*/
    signupForm.addEventListener('submit', async e => {
      e.preventDefault();
      const { data, error } = await supabase.auth.signUp({
        email: suEmail.value, password: suPass.value,
        options:{ data:{ username: suName.value }}
      });
      if (error) return alert(error.message);
      await supabase.from('profiles').insert({ id:data.user.id, username:suName.value });
      alert('Подтвердите e‑mail и войдите.');
    });

    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      const { error } = await supabase.auth.signInWithPassword({
        email: liEmail.value, password: liPass.value
      });
      if (error) return alert(error.message);
      checkSession();
    });

    logoutBtn.onclick = async () => { await supabase.auth.signOut(); location.reload(); };

    /*── 6. Навигация ───────────────────────────────────────────────────*/
    document.querySelectorAll('.service-btn').forEach(btn =>
      btn.onclick = () => loadService(btn.dataset.service));

    function executeScripts(parent) {
      parent.querySelectorAll('script').forEach(old => {
        const s = document.createElement('script');
        [...old.attributes].forEach(a => s.setAttribute(a.name, a.value));
        s.textContent = old.textContent;
        document.body.appendChild(s); old.remove();
      });
    }

    async function loadService(n) {
      const html = await fetch(`modal${n}.html?ts=${Date.now()}`).then(r => r.text());
      const container = document.getElementById('content');
      container.innerHTML = html;
      executeScripts(container);
      document.dispatchEvent(new CustomEvent('supabase-ready', { detail:{ supabase }}));
    }

    /*── Init ───────────────────────────────────────────────────────────*/
    checkSession();
  </script>
</body>
</html>
