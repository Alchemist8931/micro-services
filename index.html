<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ğ¾Ğµ Ğ²ĞµĞ±â€‘Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ</title>

  <!-- Tailwind (CDNâ€‘Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ â€” Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ´Ğ»Ñ Ğ´ĞµĞ¼Ğ¾) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- â–ˆ  Ğ¨Ğ°Ğ¿ĞºĞ°  â–ˆ -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑÑ‹</h1>
    <div id="user-info" class="hidden">
      <span id="username" class="mr-4"></span>
      <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
    </div>
  </header>

  <!-- â–ˆ  ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚  â–ˆ -->
  <div class="flex flex-1">
    <nav id="sidebar" class="w-56 bg-white border-r p-4 hidden">
      <ul class="space-y-2">
        <li><button data-service="1" class="service-btn w-full text-left px-3 py-2 rounded hover:bg-gray-200">ğŸ› ï¸ ĞŸĞ¾Ğ´Ğ±Ğ¾Ñ€ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</button></li>
        <li><button data-service="2" class="service-btn w-full text-left px-3 py-2 rounded hover:bg-gray-200">ğŸ“„ Ğ¡ĞµÑ€Ğ²Ğ¸ÑÂ 2 (ÑĞºĞ¾Ñ€Ğ¾)</button></li>
        <li><button data-service="3" class="service-btn w-full text-left px-3 py-2 rounded hover:bg-gray-200">ğŸ“Š Ğ¡ĞµÑ€Ğ²Ğ¸ÑÂ 3 (ÑĞºĞ¾Ñ€Ğ¾)</button></li>
      </ul>
    </nav>

    <main id="content" class="flex-1 p-6"></main>
  </div>

  <!-- â–ˆ  ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°  â–ˆ -->
  <div id="auth-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center">
    <div class="bg-white p-8 rounded shadow w-96">
      <!-- Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ -->
      <form id="signup-form" class="space-y-3">
        <h2 class="text-lg font-semibold">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</h2>
        <input id="su-email"  type="email"    placeholder="Eâ€‘mail"  class="w-full border px-3 py-2" required>
        <input id="su-pass"   type="password" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ"  class="w-full border px-3 py-2" required>
        <input id="su-name"   type="text"     placeholder="Ğ˜Ğ¼Ñ"     class="w-full border px-3 py-2" required>
        <button class="bg-blue-600 text-white w-full py-2 rounded">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</button>
      </form>
      <hr class="my-4">
      <!-- Ğ’Ñ…Ğ¾Ğ´ -->
      <form id="login-form" class="space-y-3">
        <h2 class="text-lg font-semibold">Ğ’Ñ…Ğ¾Ğ´</h2>
        <input id="li-email" type="email"    placeholder="Eâ€‘mail"  class="w-full border px-3 py-2" required>
        <input id="li-pass"  type="password" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ"  class="w-full border px-3 py-2" required>
        <button class="bg-green-600 text-white w-full py-2 rounded">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
      </form>
    </div>
  </div>

  <!-- â–ˆ  ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ (ESâ€‘Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ)  â–ˆ -->
  <script type="module">
    /* â”€â”€â”€ 1. ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const SUPABASE_URL = 'https://uuzsujqizwkqhwijrszr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1enN1anFpendrcWh3aWpyc3pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5OTkzMDMsImV4cCI6MjA2MzU3NTMwM30.g9OD47l7kTVvK628mffBNwcX6gZXMiM8MoAK5uq0gBo';

    const OPENAI_KEY  = 'sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'; // â† ÑĞ²Ğ¾Ğ¹
    window.OPENAI_KEY = OPENAI_KEY;

    /* â”€â”€â”€ 2. Supabase  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /* â”€â”€â”€ 3. UIâ€‘ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    export async function refreshBalance() {
      const uid = (await supabase.auth.getUser()).data.user.id;
      const { data, error } = await supabase
        .from('profiles')
        .select('username, balance')
        .eq('id', uid).single();
      if (error) { console.error(error); return; }
      document.getElementById('username').textContent =
        `${data.username || 'ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ'} | â‚½${data.balance}`;
    }
    window.refreshBalance = refreshBalance;   // Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ²Ğ¾ Ğ²ÑĞµÑ… modalâ€‘ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°Ñ…

    /* â”€â”€â”€ 4. ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function checkSession() {
      const { data:{ session }} = await supabase.auth.getSession();
      if (session) startApp(); else
        document.getElementById('auth-modal').classList.remove('hidden');
    }

    async function startApp() {
      document.getElementById('auth-modal').classList.add('hidden');
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('user-info').classList.remove('hidden');
      await refreshBalance();
      loadService(1);                       // Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
    }

    /* â”€â”€â”€ 5. Ğ¡Ğ»ÑƒÑˆĞ°Ñ‚ĞµĞ»Ğ¸ Ñ„Ğ¾Ñ€Ğ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    document.getElementById('signup-form').addEventListener('submit', async e => {
      e.preventDefault();
      const email = suEmail.value,  pass = suPass.value,  name = suName.value;
      const { data, error } = await supabase.auth.signUp({
        email, password: pass, options:{ data:{ username:name }}
      });
      if (error) return alert(error.message);
      await supabase.from('profiles').insert({ id:data.user.id, username:name });
      alert('ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ eâ€‘mail Ğ¸ Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ.');
    });

    document.getElementById('login-form').addEventListener('submit', async e => {
      e.preventDefault();
      const { error } = await supabase.auth.signInWithPassword({
        email: liEmail.value, password: liPass.value
      });
      if (error) return alert(error.message);
      checkSession();
    });

    logoutBtn.onclick = async () => { await supabase.auth.signOut(); location.reload(); };

    /* â”€â”€â”€ 6. ĞĞ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    document.querySelectorAll('.service-btn').forEach(btn =>
      btn.onclick = () => loadService(btn.dataset.service));

    /* helper: Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ’Ğ¡Ğ•Ğ¥ <script> Ğ¸Ğ· Ğ²ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ HTML */
    function executeScripts(parent) {
      parent.querySelectorAll('script').forEach(old => {
        const s = document.createElement('script');
        [...old.attributes].forEach(a => s.setAttribute(a.name, a.value));
        s.textContent = old.textContent;
        document.body.appendChild(s); old.remove();
      });
    }

    /* Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ modalN.html */
    async function loadService(n) {
      const html = await fetch(`modal${n}.html?ts=${Date.now()}`).then(r => r.text());
      const wrapper = document.getElementById('content');
      wrapper.innerHTML = html;
      executeScripts(wrapper);
      /* Ğ´ĞµĞ»Ğ¸Ğ¼ÑÑ Supabaseâ€‘SDK */
      document.dispatchEvent(new CustomEvent('supabase-ready', { detail:{ supabase }}));
    }

    /* â”€â”€â”€ 7. Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    checkSession();
  </script>
</body>
</html>
