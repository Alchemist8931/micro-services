
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Подбор оборудования</title>

  <!-- Supabase + TUS (без defer) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/tus-js-client@3.1.0/dist/tus.min.js"></script>


  <style>
    /* базовые стили */
    *, *::before, *::after { box-sizing:border-box }
    body{margin:0;font-family:Inter,Arial,sans-serif;background:#f5f5f5;
         display:flex;justify-content:center;min-height:100vh;padding:2rem}
    .uploader{width:820px;background:#fff;border-radius:24px;padding:32px;
              box-shadow:0 4px 24px rgba(0,0,0,.08)}
    /* drop‑zone */
    .dropzone{position:relative;border:2px dashed #d9d9d9;border-radius:16px;padding:48px 24px;
              text-align:center;cursor:pointer;transition:background .2s;display:block}
    .dropzone.dragover{background:#fafafa}
    .dropzone svg{width:48px;height:48px;color:#8c8c8c}
    .dropzone p{margin:12px 0 0;font-size:14px;color:#8c8c8c}
    /* список */
    .files{margin-top:24px}
    .file-item{display:flex;align-items:center;justify-content:space-between;
               border:1px solid #eee;border-radius:12px;padding:12px 16px;margin-bottom:12px}
    .file-item span{font-size:14px;color:#333}
    /* кнопка */
    .send-btn{width:100%;padding:14px;margin-top:8px;border:none;border-radius:12px;
              background:#000;color:#fff;font-size:16px;font-weight:600;cursor:pointer;
              transition:opacity .2s}
    .send-btn:disabled{opacity:.4;cursor:not-allowed}
    /* история */
    .history{margin-top:40px}
    .history h2{font-size:16px;margin:0 0 12px;color:#333}
    .history-item{border-bottom:1px solid #eee;padding:8px 0;font-size:13px;line-height:1.4}
    .history-item a{color:#0066cc;text-decoration:none}
  </style>
</head>
<body>
  <div class="uploader">

    <!-- label делает всю зону кликабельной -->
    <!-- …внутри .uploader -->
<div id="dropzone" class="dropzone" >
  <!-- прозрачный input растянут на всю область -->
  <input id="file-input" type="file"
         accept=".pdf,.doc,.docx,.txt,.xlsx,.zip"
         style="position:absolute;inset:0;opacity:0;cursor:pointer" />

  <!-- декоративная иконка/текст (не перехватывает клик) -->
  <div style="pointer-events:none">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="16 16 12 12 8 16"></polyline>
      <line x1="12" y1="12" x2="12" y2="21"></line>
      <path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path>
      <polyline points="16 16 12 12 8 16"></polyline>
    </svg>
    <p>Перетащите файл сюда или нажмите<br><small>максимум 20 МБ</small></p>
  </div>
</div>

    <div id="files" class="files"></div>
    <button id="send-btn" class="send-btn" disabled>Отправить на подбор оборудования</button>

    <div class="history">
      <h2>История</h2>
      <div id="history-list"></div>
    </div>
  </div>

<script type="module">
    
    /* ---------- Supabase init ---------- */
    const SUPABASE_URL = 'https://nnelvjvcxqugsevbykfn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uZWx2anZjeHF1Z3NldmJ5a2ZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzNzI1NzcsImV4cCI6MjA2Mzk0ODU3N30.hTaareGOoQ4Mp9ft3HfNmktqSGb9l2Ie4TGyE1X-ibI';
    const FUNCTIONS_URL = 'https://nnelvjvcxqugsevbykfn.supabase.co/functions/v1/equip-selector';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 2) DOM‑элементы
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const tbody     = document.querySelector('#historyTable tbody');

    // 3) «Очистка» имени файла
    function sanitizeFileName(name) {
      return name
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9._-]/g, '_');
    }

    // 4) Загрузка истории
    async function loadRequests() {
      tbody.innerHTML = '';
      const { data, error } = await supabase
        .from('requests')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Ошибка при загрузке истории:', error);
        return;
      }

      for (const r of data) {
        const publicUrl = r.response_path
          ? supabase
              .storage
              .from('user-uploads')
              .getPublicUrl(r.response_path)
              .data.publicUrl
          : null;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${r.file_path}</td>
          <td>${r.status}</td>
          <td>${publicUrl
            ? `<a href="${publicUrl}" target="_blank">Скачать CSV</a>`
            : '—'}</td>`;
        tbody.appendChild(tr);
      }
    }

    // 5) Загрузка и отправка
    async function uploadAndSend() {
      const file = fileInput.files[0];
      if (!file) {
        alert('Пожалуйста, выберите файл ТЗ.');
        return;
      }

      // 5.1) Подготавливаем ключ
      const cleanName = sanitizeFileName(file.name);
      const filePath  = `${Date.now()}_${cleanName}`;

      // 5.2) Загружаем в бакет user-uploads
      const { error: uploadError } = await supabase
        .storage
        .from('user-uploads')
        .upload(filePath, file, { upsert: true });
      if (uploadError) {
        alert('Ошибка загрузки файла: ' + uploadError.message);
        return;
      }

      // 5.3) Создаём запись в таблице
      const { data: reqData, error: insertError } = await supabase
        .from('requests')
        .insert({ file_path: filePath, status: 'pending' })
        .select()
        .single();
      if (insertError) {
        alert('Ошибка при создании записи: ' + insertError.message);
        return;
      }

      // 5.4) Вызываем Edge Function
      const fnRes = await fetch(FUNCTIONS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ request_id: reqData.id })
      });
      if (!fnRes.ok) {
        console.error('Edge Function error:', await fnRes.text());
      }

      // 5.5) Перезагружаем историю
      await loadRequests();
    }

    uploadBtn.addEventListener('click', uploadAndSend);

    // Initial
    loadRequests();
  </script>
</body>
</html>
