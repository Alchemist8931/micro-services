<!-- modal1.html – отправка ТЗ → CSV‑ответ от GPT -->
<section class="space-y-6">
  <h2 class="text-2xl font-semibold mb-4">🛠️ Подбор оборудования по ТЗ</h2>

  <!-- ░░ Форма запроса ░░ -->
  <form id="req-form" class="bg-white p-6 rounded shadow space-y-4">
    <textarea id="prompt" rows="4" class="w-full border p-3"
              placeholder="Введите запрос…"></textarea>
    <input type="file" id="ts-file"
           accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" required>
    <button class="bg-blue-600 text-white px-4 py-2 rounded">Отправить</button>
  </form>

  <div id="status" class="hidden text-sm text-gray-600"></div>

  <div>
    <h3 class="text-lg font-semibold mb-2">История</h3>
    <table id="history" class="min-w-full bg-white rounded shadow text-sm">
      <thead class="bg-gray-100">
        <tr><th class="p-2 text-left">Дата</th>
            <th class="p-2 text-left">Запрос</th>
            <th class="p-2 text-left">Файл‑ответ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script type="module">
let supabase;
document.addEventListener('supabase-ready', (e) => {
  supabase = e.detail.supabase;
  loadHistory();
});

  async function loadService(no) {
  const html = await fetch(`modal${no}.html`).then(r => r.text());
  const container = document.getElementById('content');
  container.innerHTML = html;

  // вытаскиваем ВСЕ <script> из вставленного HTML и исполняем
  container.querySelectorAll('script').forEach(oldScript => {
    const newScript = document.createElement('script');
    // копируем атрибуты
    [...oldScript.attributes].forEach(a => newScript.setAttribute(a.name, a.value));
    newScript.textContent = oldScript.textContent;
    document.body.appendChild(newScript);      // запускаем
    oldScript.remove();                        // убираем «мертвый» тег
  });

  document.dispatchEvent(new CustomEvent('supabase-ready', { detail: { supabase } }));
}


/*────────────────── Обработчик формы ──────────────────*/
document.getElementById('req-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  try {
    const fileInput = document.getElementById('ts-file');
    const prompt    = document.getElementById('prompt').value.trim();
    if (!fileInput.files.length) return alert('Приложите файл ТЗ');

    /* 1. списываем 400 ед. */
    const uid = (await supabase.auth.getUser()).data.user.id;
    const { data: newBal, error: billErr } =
          await supabase.rpc('charge_balance', { p_uid: uid, p_amount: 400 });

    if (billErr)      throw new Error(billErr.message);
    if (newBal === null)
      return alert('Недостаточно средств (нужно 400)');

    window.refreshBalance?.();                   // сразу отображаем

    /* 2. загружаем файл */
    const file      = fileInput.files[0];
    const filename  = `${crypto.randomUUID()}_${file.name}`;
    const { error: upErr } = await supabase
      .storage.from('user-uploads')
      .upload(filename, file, { upsert:false });

    if (upErr) throw new Error(upErr.message);
    const filePath = filename;                   // гарантированно существует

    /* 3. вставляем строку в service_requests */
    setStatus('Создание запроса…');
    const { data: reqRow, error: insErr } = await supabase
      .from('service_requests')
      .insert({ user_id:uid, service_no:1, prompt, file_path:filePath })
      .select('*').single();

    if (insErr) throw new Error('insert: ' + insErr.message);
    if (!reqRow) throw new Error('RLS блокирует INSERT');

    /* 4. подготавливаем текст для GPT */
    let fileText = '';
    try {
      fileText = await file.text();
      if (fileText.length > 12_000)
        fileText = fileText.slice(0, 12_000) + ' …[обрезано]';
    } catch { /* бинарные пропускаем */ }

    /* 5. запрос к OpenAI */
    setStatus('Обработка GPT — ждём ответ…');
    const gptBody = {
      model:'gpt-4o-mini',
      temperature:0.2,
      messages:[
        { role:'system',
          content:'Ты инженер‑сметчик. Составь CSV‑таблицу оборудования по ТЗ.' },
        { role:'user',
          content:`Запрос: «${prompt}»\n\nФайл (фрагмент):\n${fileText}` }
      ]
    };

    const gpt = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${window.OPENAI_KEY}`
      },
      body:JSON.stringify(gptBody)
    });

    if (!gpt.ok)
      throw new Error('OpenAI HTTP ' + gpt.status + ': ' + await gpt.text());

    const { choices } = await gpt.json();
    const csvText = choices?.[0]?.message?.content || '';

    /* 6. сохраняем CSV‑ответ */
    const resultPath = `${reqRow.id}.csv`;
    const { error: upResErr } = await supabase.storage.from('user-uploads')
      .upload(resultPath, new Blob([csvText], { type:'text/csv' }), { upsert:true });
    if (upResErr) throw new Error('upload result: ' + upResErr.message);

    /* 7. UPDATE строки */
    const { error: updErr } = await supabase
      .from('service_requests')
      .update({ response_path:resultPath, status:'done' })
      .eq('id', reqRow.id);
    if (updErr) throw new Error('update: ' + updErr.message);

    setStatus('Готово ✅');
    loadHistory();
    e.target.reset();
  } catch (err) {
    console.error(err);
    setStatus('Ошибка: ' + err.message);
    // при откате надо вернуть деньги?  ─ зависит от логики; пока пропускаем
  }
});

/*────────────────── История запросов ──────────────────*/
async function loadHistory() {
  const tbody = document.querySelector('#history tbody');
  tbody.innerHTML = '';

  const { data, error } = await supabase
    .from('service_requests')
    .select('id,created_at,prompt,response_path')
    .eq('service_no',1)
    .eq('user_id',(await supabase.auth.getUser()).data.user.id)
    .order('created_at',{ ascending:false });

  if (error) { console.error(error); return; }

  for (const row of data) {
    const pubUrl = row.response_path
      ? supabase.storage.from('user-uploads')
        .getPublicUrl(row.response_path).data.publicUrl
      : null;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border-t p-2">${new Date(row.created_at).toLocaleString()}</td>
      <td class="border-t p-2">${row.prompt.slice(0,70)}…</td>
      <td class="border-t p-2">
        ${pubUrl ? `<a href="${pubUrl}" target="_blank"
                      class="underline text-blue-600">скачать</a>` : '—'}
      </td>`;
    tbody.appendChild(tr);
  }
}

/*────────────────── Утилита статуса ──────────────────*/
function setStatus(t) {
  const el = document.getElementById('status');
  el.textContent = t;
  el.classList.remove('hidden');
}
</script>
