<!-- modal1.html -->
<section class="space-y-6">
  <h2 class="text-2xl font-semibold mb-4">ğŸ› ï¸ ĞŸĞ¾Ğ´Ğ±Ğ¾Ñ€ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ Ğ¢Ğ—</h2>

  <!-- â–‘â–‘ Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° â–‘â–‘ -->
  <form id="req-form" class="bg-white p-6 rounded shadow space-y-4">
    <!--//Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ-->
    <textarea id="prompt" rows="4" class="w-full border p-3" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñâ€¦"></textarea>

    <!--//Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ°-->
    <input type="file" id="ts-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.csv" required>

    <!--//ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸-->
    <button class="bg-blue-600 text-white px-4 py-2 rounded">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
  </form>

  <!-- â–‘â–‘ Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° â–‘â–‘ -->
  <div id="status" class="hidden text-sm text-gray-600"></div>

  <!-- â–‘â–‘ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² â–‘â–‘ -->
  <div>
    <h3 class="text-lg font-semibold mb-2">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</h3>
    <table id="history" class="min-w-full bg-white rounded shadow text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 text-left">Ğ”Ğ°Ñ‚Ğ°</th>
          <th class="p-2 text-left">Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ</th>
          <th class="p-2 text-left">Ğ¤Ğ°Ğ¹Ğ»â€‘Ğ¾Ñ‚Ğ²ĞµÑ‚</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script type="module">
  //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  //Ğ´Ğ¾ÑÑ‚Ğ°Ñ‘Ğ¼ supabase, Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ· index.html
  //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let supabase;
  document.addEventListener('supabase-ready', (e) => {
    supabase = e.detail.supabase;
    loadHistory();
  });

  //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  //Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ñ‹
  //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('req-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('ts-file');
    const prompt    = document.getElementById('prompt').value.trim();

    if (!fileInput.files.length) return alert('ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ğ¢Ğ—');

    // //Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
    setStatus('Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ°â€¦');

    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ğ² Storage
    const file      = fileInput.files[0];
    const filename  = `${crypto.randomUUID()}_${file.name}`;
    const { data: uploadData, error: upErr } = await supabase
      .storage.from('user-uploads')
      .upload(filename, file, { upsert: false });

    if (upErr) { setStatus(upErr.message); return; }
    const filePath = uploadData.path;

    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² service_requests
    setStatus('Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°â€¦');
    const { data: reqRow, error: insErr } = await supabase
      .from('service_requests')
      .insert({
        user_id: (await supabase.auth.getUser()).data.user.id,
        service_no: 1,
        prompt,
        file_path: filePath
      })
      .select('*')
      .single();

    if (insErr) { setStatus(insErr.message); return; }

    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Edgeâ€‘Functionâ€‘Ğ¿Ñ€Ğ¾ĞºÑĞ¸ â†’ GPT
    setStatus('ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° GPTâ€¦ (ÑÑ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ)');
    const proxyRes = await fetch('/functions/v1/equip-selector', {   // //Ğ¿Ñ€Ğ¾ĞºÑĞ¸â€‘Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ request_id: reqRow.id })
    });
    if (!proxyRes.ok) { setStatus('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸'); return; }
    const { result_path } = await proxyRes.json();

    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ + Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
    await supabase
      .from('service_requests')
      .update({ response_path: result_path, status: 'done' })
      .eq('id', reqRow.id);

    setStatus('Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!');
    loadHistory();          // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
    e.target.reset();       // Ñ‡Ğ¸ÑÑ‚Ğ¸Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
  });

  //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  //Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadHistory() {
    const tbody = document.querySelector('#history tbody');
    tbody.innerHTML = '';

    const { data, error } = await supabase
      .from('service_requests')
      .select('id, created_at, prompt, response_path')
      .eq('service_no', 1)
      .order('created_at', { ascending: false });

    if (error) return alert(error.message);

    for (const row of data) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border-t p-2">${new Date(row.created_at).toLocaleString()}</td>
        <td class="border-t p-2">${row.prompt.slice(0, 50)}â€¦</td>
        <td class="border-t p-2">
          ${row.response_path
            ? `<a href="${supabase.storage.from('user-uploads').getPublicUrl(row.response_path).data.publicUrl}" target="_blank" class="text-blue-600 underline">ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ</a>`
            : 'â€”'}
        </td>`;
      tbody.appendChild(tr);
    }
  }

  //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  //Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
  //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(txt) {
    const el = document.getElementById('status');
    el.textContent = txt;
    el.classList.remove('hidden');
  }
</script>
