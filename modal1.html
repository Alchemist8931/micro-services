<!-- modal1.html -->
<section class="space-y-6">
  <h2 class="text-2xl font-semibold mb-4">ğŸ› ï¸ ĞŸĞ¾Ğ´Ğ±Ğ¾Ñ€ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Â Ğ¢Ğ—</h2>

  <!-- â–‘â–‘ Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° â–‘â–‘ -->
  <form id="req-form" class="bg-white p-6 rounded shadow space-y-4">
    <!-- //Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ -->
    <textarea id="prompt" rows="4" class="w-full border p-3"
              placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñâ€¦"></textarea>

    <!-- //Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ° -->
    <input type="file" id="ts-file"
           accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" required>

    <!-- //ĞºĞ½Ğ¾Ğ¿ĞºĞ° -->
    <button class="bg-blue-600 text-white px-4 py-2 rounded">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
  </form>

  <!-- â–‘â–‘ Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° â–‘â–‘ -->
  <div id="status" class="hidden text-sm text-gray-600"></div>

  <!-- â–‘â–‘ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² â–‘â–‘ -->
  <div>
    <h3 class="text-lg font-semibold mb-2">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</h3>
    <table id="history" class="min-w-full bg-white rounded shadow text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 text-left">Ğ”Ğ°Ñ‚Ğ°</th>
          <th class="p-2 text-left">Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ</th>
          <th class="p-2 text-left">Ğ¤Ğ°Ğ¹Ğ»â€‘Ğ¾Ñ‚Ğ²ĞµÑ‚</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script type="module">
/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Supabase Ğ¸Ğ· index.html â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
let supabase;
document.addEventListener('supabase-ready', (e) => {
  supabase = e.detail.supabase;
  loadHistory();
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
document.getElementById('req-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  /*â€„2.1  Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ */
  const fileInput = document.getElementById('ts-file');
  const prompt    = document.getElementById('prompt').value.trim();
  if (!fileInput.files.length) return alert('ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ğ¢Ğ—');

  /*â€„2.2  ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ 400 ĞµĞ´. */
  const uid = (await supabase.auth.getUser()).data.user.id;
  const { data: newBalance, error: billErr } =
        await supabase.rpc('charge_balance', { p_uid: uid, p_amount: 400 });
  if (billErr)  { alert(billErr.message); return; }
  if (newBalance === null) {
    alert('ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑ€ĞµĞ´ÑÑ‚Ğ² (Ğ½ÑƒĞ¶Ğ½Ğ¾ 400)'); return;
  }
  window.refreshBalance?.();

  /*â€„2.3  Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ğ² Storage */
  const file     = fileInput.files[0];
  const filename = `${crypto.randomUUID()}_${file.name}`;
  const { data: up, error: upErr } = await supabase
        .storage.from('user-uploads').upload(filename, file, { upsert:false });
  if (upErr) { setStatus(upErr.message); return; }
  const filePath = up.path;

  /*â€„2.4  ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² service_requests (status=pending) */
  setStatus('Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°â€¦');
  const { data: reqRow, error: insErr } = await supabase
        .from('service_requests')
        .insert({
          user_id: uid, service_no:1, prompt, file_path: filePath
        })
        .select('*').single();
  if (insErr) { setStatus(insErr.message); return; }

  /*â€„2.5  Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¼ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ GPT */
  let fileText = '';
  try {
    fileText = await file.text();
    if (fileText.length > 12_000)
      fileText = fileText.slice(0, 12_000) + ' â€¦[Ğ¾Ğ±Ñ€ĞµĞ·Ğ°Ğ½Ğ¾]';
  } catch { /* Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼Ğ¸ */ }

  /*â€„2.6  Ğ²Ñ‹Ğ·Ğ¾Ğ² OpenAI */
  setStatus('ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° GPTâ€¦ (Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ Ğ´Ğ¾Â Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹)');
  const gptBody = {
    model: 'gpt-4o-mini',
    temperature: 0.2,
    messages: [
      { role:'system',
        content:'Ğ¢Ñ‹ Ğ¸Ğ½Ğ¶ĞµĞ½ĞµÑ€â€‘ÑĞ¼ĞµÑ‚Ñ‡Ğ¸Ğº. Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ Ğ¢Ğ—.' },
      { role:'user',
        content:
          `Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ: Â«${prompt}Â»\n\n` +
          `Ğ¤Ğ°Ğ¹Ğ» (Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚):\n${fileText}` }
    ]
  };
  const openaiRes = await fetch('https://api.openai.com/v1/chat/completions', {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${window.OPENAI_KEY}`
    },
    body: JSON.stringify(gptBody)
  });
  if (!openaiRes.ok) {
    const err = await openaiRes.text();
    setStatus('OpenAI error: ' + err);
    return;
  }
  const { choices } = await openaiRes.json();
  const csvText = choices?.[0]?.message?.content || 'â€”';

  /*â€„2.7  ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ CSVâ€‘Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ² Storage */
  const resultPath = `${reqRow.id}.csv`;
  await supabase.storage.from('user-uploads')
        .upload(resultPath,
                new Blob([csvText], { type:'text/csv;charset=utf-8' }),
                { upsert:true });

  /*â€„2.8  Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ UPDATE ÑÑ‚Ñ€Ğ¾ĞºĞ¸ */
  await supabase
        .from('service_requests')
        .update({ response_path: resultPath, status:'done' })
        .eq('id', reqRow.id);

  setStatus('Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!');
  loadHistory();
  e.target.reset();
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function loadHistory() {
  const tbody = document.querySelector('#history tbody');
  tbody.innerHTML = '';

  const { data, error } = await supabase
    .from('service_requests')
    .select('id,created_at,prompt,response_path')
    .eq('service_no', 1)
    .eq('user_id', (await supabase.auth.getUser()).data.user.id)
    .order('created_at', { ascending:false });

  if (error) return alert(error.message);

  for (const row of data) {
    const pubUrl = row.response_path
      ? supabase.storage.from('user-uploads')
        .getPublicUrl(row.response_path).data.publicUrl
      : null;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border-t p-2">${new Date(row.created_at)
            .toLocaleString()}</td>
      <td class="border-t p-2">${row.prompt.slice(0,50)}â€¦</td>
      <td class="border-t p-2">
        ${pubUrl ? `<a href="${pubUrl}" class="underline text-blue-600"
                      target="_blank">ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ</a>` : 'â€”'}
      </td>`;
    tbody.appendChild(tr);
  }
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. ĞœĞ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹ helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function setStatus(txt) {
  const el = document.getElementById('status');
  el.textContent = txt;
  el.classList.remove('hidden');
}
</script>
