<!-- modal1.html -->
<section class="space-y-6">
  <h2 class="text-2xl font-semibold mb-4">üõ†Ô∏è –ü–æ–¥–±–æ—Ä –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ¬†–¢–ó</h2>

  <form id="req-form" class="bg-white p-6 rounded shadow space-y-4">
    <textarea id="prompt-field" rows="4" class="w-full border p-3"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å‚Ä¶"></textarea>
    <input  id="ts-file" type="file"
            accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" required>
    <button class="bg-blue-600 text-white px-4 py-2 rounded">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>

  <div id="status" class="hidden text-sm text-gray-600"></div>

  <div>
    <h3 class="text-lg font-semibold mb-2">–ò—Å—Ç–æ—Ä–∏—è</h3>
    <table id="history" class="min-w-full bg-white rounded shadow text-sm">
      <thead class="bg-gray-100">
        <tr><th class="p-2">–î–∞—Ç–∞</th><th class="p-2">–ó–∞–ø—Ä–æ—Å</th><th class="p-2">–§–∞–π–ª‚Äë–æ—Ç–≤–µ—Ç</th></tr>
      </thead><tbody></tbody>
    </table>
  </div>
</section>

<script type="module">
/* ‚îÄ‚îÄ 1.  –∂–¥—ë–º Supabase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
let supabase;          //¬†–±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω –≤ –∫–æ–ª–±—ç–∫–µ
document.addEventListener('supabase-ready', onReady, { once:true });

function onReady(e) {
  supabase = e.detail.supabase;           // ‚Üê —Ç–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ –µ—Å—Ç—å
  attachSubmitHandler();                  // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å
  loadHistory();                          // –∏ —Å—Ä–∞–∑—É –∑–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
}

/* ‚îÄ‚îÄ 2.  –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function attachSubmitHandler() {
  const form   = document.getElementById('req-form');
  const fileIn = document.getElementById('ts-file');
  const promptIn = document.getElementById('prompt-field');
  const status = document.getElementById('status');

  form.addEventListener('submit', async ev => {
    ev.preventDefault();
    try {
      if (!fileIn.files.length) { alert('–ü—Ä–∏–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª –¢–ó'); return; }
      const file   = fileIn.files[0];
      const prompt = promptIn.value.trim();

      /* 2.1 —Å–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å */
      const uid = (await supabase.auth.getUser()).data.user.id;
      const { data:newBal, error:billErr } =
        await supabase.rpc('charge_balance', { p_uid:uid, p_amount:400 });
      if (billErr) throw billErr;
      if (newBal === null) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
      window.refreshBalance?.();

      /* 2.2 upload –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ */
      const fname = `${crypto.randomUUID()}_${file.name}`;
      const { error:upErr } =
        await supabase.storage.from('user-uploads').upload(fname, file);
      if (upErr) throw upErr;

      /* 2.3 –∑–∞–ø–∏—Å—å –≤ history */
      setStatus('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞‚Ä¶');
      const { data:reqRow, error:insErr } = await supabase
        .from('service_requests')
        .insert({ user_id:uid, service_no:1, prompt, file_path:fname })
        .select('*').single();
      if (insErr) throw insErr;

      /* 2.4 –≤—ã–∑–æ–≤ GPT */
      setStatus('GPT –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç‚Ä¶');
      let snippet = ''; try { snippet = (await file.text()).slice(0,12000);}catch{}
      const body = {
        model:'gpt-4o-mini',
        messages:[
          { role:'system', content:'–¢—ã –∏–Ω–∂–µ–Ω–µ—Ä‚Äë—Å–º–µ—Ç—á–∏–∫. –°–æ—Å—Ç–∞–≤—å CSV‚Äë—Ç–∞–±–ª–∏—Ü—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.'},
          { role:'user',   content:`–ó–∞–ø—Ä–æ—Å: ¬´${prompt}¬ª\n\n–§–∞–π–ª:\n${snippet}` }
        ]
      };
      const gpt = await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{ 'Content-Type':'application/json',
                  'Authorization':`Bearer ${window.OPENAI_KEY}`},
        body:JSON.stringify(body)
      });
      if (!gpt.ok) throw new Error('OpenAI ' + gpt.status);
      const csv = (await gpt.json()).choices?.[0]?.message?.content || '';

      /* 2.5 upload —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
      const csvPath = `${reqRow.id}.csv`;
      await supabase.storage.from('user-uploads')
        .upload(csvPath, new Blob([csv],{ type:'text/csv' }), { upsert:true });

      /* 2.6 UPDATE history */
      await supabase.from('service_requests')
        .update({ response_path:csvPath, status:'done' })
        .eq('id', reqRow.id);

      setStatus('–ì–æ—Ç–æ–≤–æ ‚úÖ');
      loadHistory();
      form.reset();
    } catch (err) {
      console.error(err);
      setStatus('–û—à–∏–±–∫–∞: ' + (err.message || err));
    }
  });

  function setStatus(txt){ status.textContent = txt; status.classList.remove('hidden'); }
}

/* ‚îÄ‚îÄ 3.  –∏—Å—Ç–æ—Ä–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
async function loadHistory() {
  const tbody = document.querySelector('#history tbody'); tbody.innerHTML = '';
  const uid = (await supabase.auth.getUser()).data.user.id;
  const { data, error } = await supabase
    .from('service_requests')
    .select('*').eq('user_id',uid).eq('service_no',1)
    .order('created_at',{ ascending:false });
  if (error) { console.error(error); return; }

  for (const r of data) {
    const link = r.response_path
      ? supabase.storage.from('user-uploads').getPublicUrl(r.response_path).data.publicUrl
      : null;
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td class="border-t p-2">${new Date(r.created_at).toLocaleString()}</td>
        <td class="border-t p-2">${r.prompt.slice(0,60)}‚Ä¶</td>
        <td class="border-t p-2">${link
          ? `<a href="${link}" target="_blank" class="underline text-blue-600">—Å–∫–∞—á–∞—Ç—å</a>`
          : '‚Äî'}</td>
      </tr>`);
  }
}
</script>
