<!-- modal1.html â€“ Â«ĞŸĞ¾Ğ´Ğ±Ğ¾Ñ€ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ÑÂ» (PicoÂ CSS) -->
<section>
  <h2>ğŸ› ï¸Â ĞŸĞ¾Ğ´Ğ±Ğ¾Ñ€ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Â Ğ¢Ğ—</h2>

  <form id="req-form">
    <textarea id="prompt-field" rows="4"
              placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñâ€¦"></textarea>
    <input id="ts-file" type="file"
           accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" required>
    <button class="contrast">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
  </form>

  <aside id="status" hidden></aside>

  <h3>Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</h3>
  <table id="history">
    <thead>
      <tr><th>Ğ”Ğ°Ñ‚Ğ°</th><th>Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ</th><th>Ğ¤Ğ°Ğ¹Ğ»â€‘Ğ¾Ñ‚Ğ²ĞµÑ‚</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script type="module">
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 0. ĞšĞ»Ğ¸ĞµĞ½Ñ‚ + bucket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const supabase = window.sb;
const BUCKET   = 'user-uploads';   // â† Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼Ñ Ñ‚Ğ¾Ñ‡ÑŒâ€‘Ğ²â€‘Ñ‚Ğ¾Ñ‡ÑŒ ĞºĞ°Ğº Ğ² Dashboard

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const form   = document.getElementById('req-form');
const fInput = document.getElementById('ts-file');
const pInput = document.getElementById('prompt-field');
const status = document.getElementById('status');
const tbody  = document.querySelector('#history tbody');

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
form.addEventListener('submit', onSubmit);
loadHistory();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function onSubmit(e){
  e.preventDefault();
  try{
    if(!fInput.files.length){alert('ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ğ¢Ğ—');return;}
    const file   = fInput.files[0];
    const prompt = pInput.value.trim();
    const uid    = (await supabase.auth.getUser()).data.user.id;

    /* 3.1 ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ 400 */
    const {data:newBal,error:billErr}=await supabase
      .rpc('charge_balance',{p_uid:uid,p_amount:400});
    if(billErr) throw billErr;
    if(newBal===null){alert('ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑ€ĞµĞ´ÑÑ‚Ğ²');return;}
    window.refreshBalance?.();

    /* 3.2 upload Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ° */
    const sanitize = str => str.normalize('NFKD').replace(/[^\w.\-]/g,'_');
    const srcPath  = `${uid}/${crypto.randomUUID()}_${sanitize(file.name)}`;

    const up1 = await supabase
  .storage.from(BUCKET)
  .upload(srcPath, file, { contentType: file.type });

    /* 3.3 Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² history */
    setStatus('Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°â€¦');
    const ins=await supabase.from('service_requests')
      .insert({user_id:uid,service_no:1,prompt,file_path:srcPath})
      .select('*').single();
    if(ins.error) throw ins.error;
    const reqRow=ins.data;

    /* 3.4 GPT */
    setStatus('GPT Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚â€¦');
    let snippet='';try{snippet=(await file.text()).slice(0,12000);}catch{}
    const body={
      model:'gpt-4o-mini',
      messages:[
        {role:'system',content:'Ğ¢Ñ‹ Ğ¸Ğ½Ğ¶ĞµĞ½ĞµÑ€â€‘ÑĞ¼ĞµÑ‚Ñ‡Ğ¸Ğº. Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ CSVâ€‘Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.'},
        {role:'user',content:`Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ: Â«${prompt}Â»\n\nĞ¤Ğ°Ğ¹Ğ»:\n${snippet}`}
      ]};
    const gpt=await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json',
               'Authorization':`Bearer ${window.OPENAI_KEY}`},
      body:JSON.stringify(body)});
    if(!gpt.ok) throw new Error('OpenAI '+gpt.status);
    const csv=(await gpt.json()).choices?.[0]?.message?.content||'';

    /* 3.5 upload CSVâ€‘Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° */
    const resPath=`${uid}/${reqRow.id}.csv`;
    const up2=await supabase.storage.from(BUCKET)
      .upload(resPath,new Blob([csv],{type:'text/csv'}),{upsert:true});
    if(up2.error) throw up2.error;

    /* 3.6 UPDATE history */
    await supabase.from('service_requests')
      .update({response_path:resPath,status:'done'})
      .eq('id',reqRow.id);

    setStatus('Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Â âœ…');
    loadHistory();
    form.reset();
  }catch(err){
    console.error(err);
    setStatus('ĞÑˆĞ¸Ğ±ĞºĞ°: '+(err.message||err));
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function loadHistory(){
  tbody.innerHTML='';
  const uid=(await supabase.auth.getUser()).data.user.id;
  const {data}=await supabase.from('service_requests')
    .select('*').eq('user_id',uid).eq('service_no',1)
    .order('created_at',{ascending:false});
  data.forEach(r=>{
    const url=r.response_path
      ? supabase.storage.from(BUCKET).getPublicUrl(r.response_path).data.publicUrl
      : null;
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td class="border-t p-2">${new Date(r.created_at).toLocaleString()}</td>
        <td class="border-t p-2">${r.prompt.slice(0,60)}â€¦</td>
        <td class="border-t p-2">${url
          ? `<a href="${url}" target="_blank" class="underline text-blue-600">ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ</a>`
          : 'â€”'}</td>
      </tr>`);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function setStatus(t){status.textContent=t;status.classList.remove('hidden');}
</script>
