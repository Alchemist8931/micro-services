<!-- modal1.html â€“ Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸Ñ â„–1 -->
<section class="space-y-6">
  <h2 class="text-2xl font-semibold mb-4">ğŸ› ï¸ ĞŸĞ¾Ğ´Ğ±Ğ¾Ñ€ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Â Ğ¢Ğ—</h2>

  <form id="req-form" class="bg-white p-6 rounded shadow space-y-4">
    <textarea id="prompt" rows="4" class="w-full border p-3"
              placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñâ€¦"></textarea>
    <input   id="ts-file" type="file"
             accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" required>
    <button  class="bg-blue-600 text-white px-4 py-2 rounded">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
  </form>

  <div id="status" class="hidden text-sm text-gray-600"></div>

  <div>
    <h3 class="text-lg font-semibold mb-2">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</h3>
    <table id="history" class="min-w-full bg-white rounded shadow text-sm">
      <thead class="bg-gray-100">
        <tr><th class="p-2">Ğ”Ğ°Ñ‚Ğ°</th><th class="p-2">Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ</th><th class="p-2">Ğ¤Ğ°Ğ¹Ğ»â€‘Ğ¾Ñ‚Ğ²ĞµÑ‚</th></tr>
      </thead><tbody></tbody>
    </table>
  </div>
</section>

<script type="module">
/* â”€â”€â”€ 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let supabase;
document.addEventListener('supabase-ready', e => { supabase = e.detail.supabase; loadHistory(); });

/* â”€â”€â”€ 2. submit Ñ„Ğ¾Ñ€Ğ¼Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('req-form').addEventListener('submit', async e => {
  e.preventDefault();
  try {
    const file = tsFile.files[0], prompt = prompt.value.trim();
    if (!file) return alert('ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ğ¢Ğ—');

    /* 2.1 ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ 400 */
    const uid = (await supabase.auth.getUser()).data.user.id;
    const { data:newBal, error:billErr } =
      await supabase.rpc('charge_balance', { p_uid:uid, p_amount:400 });
    if (billErr) throw billErr;
    if (newBal === null) return alert('ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑ€ĞµĞ´ÑÑ‚Ğ² (400)');

    window.refreshBalance?.();

    /* 2.2 Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» */
    const fname = `${crypto.randomUUID()}_${file.name}`;
    const { error:upErr } =
      await supabase.storage.from('user-uploads').upload(fname, file, { upsert:false });
    if (upErr) throw upErr;

    /* 2.3 INSERT history (pending) */
    setStatus('Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°â€¦');
    const { data:reqRow, error:insErr } = await supabase
      .from('service_requests')
      .insert({ user_id:uid, service_no:1, prompt, file_path:fname })
      .select('*').single();
    if (insErr) throw insErr;

    /* 2.4 Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¼ Ñ‚ĞµĞºÑÑ‚ (Ğ´Ğ¾ 12â€¯k ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²) */
    let txt = ''; try { txt = (await file.text()).slice(0, 12_000); } catch {}

    /* 2.5 OpenAI */
    setStatus('GPT Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚â€¦');
    const body = {
      model:'gpt-4o-mini', temperature:0.2,
      messages:[
        { role:'system',
          content:'Ğ¢Ñ‹ Ğ¸Ğ½Ğ¶ĞµĞ½ĞµÑ€â€‘ÑĞ¼ĞµÑ‚Ñ‡Ğ¸Ğº. Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ CSVâ€‘Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.' },
        { role:'user',
          content:`Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ: Â«${prompt}Â»\n\nĞ¤Ğ°Ğ¹Ğ»:\n${txt}` }
      ]
    };
    const gpt = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST',
      headers:{ 'Content-Type':'application/json',
                'Authorization':`Bearer ${window.OPENAI_KEY}` },
      body:JSON.stringify(body)
    });
    if (!gpt.ok) throw new Error(`OpenAI ${gpt.status}`);

    const csv = (await gpt.json()).choices?.[0]?.message?.content || '';
    const resPath = `${reqRow.id}.csv`;
    await supabase.storage.from('user-uploads')
      .upload(resPath, new Blob([csv],{ type:'text/csv' }), { upsert:true });

    /* 2.6 UPDATE history */
    await supabase
      .from('service_requests')
      .update({ response_path:resPath, status:'done' })
      .eq('id', reqRow.id);

    setStatus('Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ âœ…');
    loadHistory();
    e.target.reset();
  } catch (err) {
    console.error(err);
    setStatus('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (err.message || err));
  }
});

/* â”€â”€â”€ 3. Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadHistory() {
  const tbody = history.querySelector('tbody'); tbody.innerHTML = '';
  const uid = (await supabase.auth.getUser()).data.user.id;
  const { data, error } = await supabase
    .from('service_requests')
    .select('*').eq('user_id',uid).eq('service_no',1)
    .order('created_at',{ ascending:false });
  if (error) { console.error(error); return; }
  for (const r of data) {
    const a = r.response_path
      ? `<a href="${supabase.storage.from('user-uploads')
         .getPublicUrl(r.response_path).data.publicUrl}" target="_blank"
         class="underline text-blue-600">ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ</a>` : 'â€”';
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td class="border-t p-2">${new Date(r.created_at).toLocaleString()}</td>
        <td class="border-t p-2">${r.prompt.slice(0,60)}â€¦</td>
        <td class="border-t p-2">${a}</td>
      </tr>`);
  }
}

/* â”€â”€â”€ 4. helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setStatus(t) { status.textContent = t; status.classList.remove('hidden'); }
</script>
