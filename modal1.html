<!-- modal1.html – микросервис «Подбор оборудования» -->
<section class="space-y-6">
  <h2 class="text-2xl font-semibold mb-4">🛠️ Подбор оборудования по ТЗ</h2>

  <form id="req-form" class="bg-white p-6 rounded shadow space-y-4">
    <textarea id="prompt-field" rows="4" class="w-full border p-3"
              placeholder="Введите запрос…"></textarea>
    <input id="ts-file" type="file"
           accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" required>
    <button class="bg-blue-600 text-white px-4 py-2 rounded">Отправить</button>
  </form>

  <div id="status" class="hidden text-sm text-gray-600"></div>

  <div>
    <h3 class="text-lg font-semibold mb-2">История</h3>
    <table id="history" class="min-w-full bg-white rounded shadow text-sm">
      <thead class="bg-gray-100">
        <tr><th class="p-2">Дата</th><th class="p-2">Запрос</th><th class="p-2">Файл‑ответ</th></tr>
      </thead><tbody></tbody>
    </table>
  </div>
</section>

<script type="module">
/*── 1. SDK ─────────────────────────────────────────────────────────────*/
let supabase;
document.addEventListener('supabase-ready', e => { supabase = e.detail.supabase; loadHistory(); });

/*── 2. submit ──────────────────────────────────────────────────────────*/
reqForm.addEventListener('submit', async e => {
  e.preventDefault();
  try {
    const file   = tsFile.files[0];
    const prompt = promptField.value.trim();
    if (!file) return alert('Приложите файл ТЗ');

    /* 2.1 списываем 400 */
    const uid = (await supabase.auth.getUser()).data.user.id;
    const { data:newBal, error:billErr } = await supabase.rpc('charge_balance',{ p_uid:uid, p_amount:400 });
    if (billErr) throw billErr;
    if (newBal === null) return alert('Недостаточно средств');
    window.refreshBalance?.();

    /* 2.2 upload файл */
    const fname = `${crypto.randomUUID()}_${file.name}`;
    const { error:upErr } = await supabase.storage.from('user-uploads').upload(fname, file, { upsert:false });
    if (upErr) throw upErr;

    /* 2.3 INSERT history */
    setStatus('Создание запроса…');
    const { data:reqRow, error:insErr } = await supabase
      .from('service_requests').insert({ user_id:uid, service_no:1, prompt, file_path:fname })
      .select('*').single();
    if (insErr) throw insErr;

    /* 2.4 OpenAI */
    setStatus('GPT обрабатывает…');
    let txt = ''; try { txt = (await file.text()).slice(0, 12000); } catch {}
    const gptBody = {
      model:'gpt-4o-mini', temperature:0.2,
      messages:[
        { role:'system',
          content:'Ты инженер‑сметчик. Составь CSV‑таблицу оборудования.' },
        { role:'user',
          content:`Запрос: «${prompt}»\n\nФайл (фрагмент):\n${txt}` }
      ]
    };
    const gpt = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${window.OPENAI_KEY}` },
      body:JSON.stringify(gptBody)
    });
    if (!gpt.ok) throw new Error(`OpenAI ${gpt.status}`);
    const csv = (await gpt.json()).choices?.[0]?.message?.content || '';

    /* 2.5 upload ответа */
    const resultPath = `${reqRow.id}.csv`;
    const { error:upResErr } =
      await supabase.storage.from('user-uploads').upload(resultPath, new Blob([csv],{ type:'text/csv' }), { upsert:true });
    if (upResErr) throw upResErr;

    /* 2.6 UPDATE history */
    await supabase.from('service_requests')
      .update({ response_path:resultPath, status:'done' })
      .eq('id', reqRow.id);

    setStatus('Готово ✅');
    loadHistory();
    e.target.reset();
  } catch (err) {
    console.error(err);
    setStatus('Ошибка: ' + (err.message || err));
  }
});

/*── 3. История ─────────────────────────────────────────────────────────*/
async function loadHistory() {
  const tbody = history.querySelector('tbody'); tbody.innerHTML = '';
  const uid = (await supabase.auth.getUser()).data.user.id;
  const { data, error } = await supabase
    .from('service_requests')
    .select('*').eq('user_id',uid).eq('service_no',1)
    .order('created_at',{ ascending:false });
  if (error) { console.error(error); return; }

  for (const r of data) {
    const link = r.response_path
      ? supabase.storage.from('user-uploads').getPublicUrl(r.response_path).data.publicUrl
      : null;
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td class="border-t p-2">${new Date(r.created_at).toLocaleString()}</td>
        <td class="border-t p-2">${r.prompt.slice(0,60)}…</td>
        <td class="border-t p-2">${link ? `<a href="${link}" target="_blank" class="underline text-blue-600">скачать</a>` : '—'}</td>
      </tr>`);
  }
}

/*── 4. helper ───────────────────────────────────────────────────────────*/
function setStatus(t){ status.textContent = t; status.classList.remove('hidden'); }
</script>
