<!-- modal1.html â€“Â Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¢Ğ—Â â†’Â CSVâ€‘Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚Â GPT -->
<section class="space-y-6">
  <h2 class="text-2xl font-semibold mb-4">ğŸ› ï¸ ĞŸĞ¾Ğ´Ğ±Ğ¾Ñ€ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Â Ğ¢Ğ—</h2>

  <!-- â–‘â–‘ Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° â–‘â–‘ -->
  <form id="req-form" class="bg-white p-6 rounded shadow space-y-4">
    <textarea id="prompt" rows="4" class="w-full border p-3"
              placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñâ€¦"></textarea>
    <input type="file" id="ts-file"
           accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" required>
    <button class="bg-blue-600 text-white px-4 py-2 rounded">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
  </form>

  <div id="status" class="hidden text-sm text-gray-600"></div>

  <div>
    <h3 class="text-lg font-semibold mb-2">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</h3>
    <table id="history" class="min-w-full bg-white rounded shadow text-sm">
      <thead class="bg-gray-100">
        <tr><th class="p-2 text-left">Ğ”Ğ°Ñ‚Ğ°</th>
            <th class="p-2 text-left">Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ</th>
            <th class="p-2 text-left">Ğ¤Ğ°Ğ¹Ğ»â€‘Ğ¾Ñ‚Ğ²ĞµÑ‚</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script type="module">
let supabase;
document.addEventListener('supabase-ready', (e) => {
  supabase = e.detail.supabase;
  loadHistory();
});

  async function loadService(no) {
  const html = await fetch(`modal${no}.html`).then(r => r.text());
  const container = document.getElementById('content');
  container.innerHTML = html;

  // Ğ²Ñ‹Ñ‚Ğ°ÑĞºĞ¸Ğ²Ğ°ĞµĞ¼ Ğ’Ğ¡Ğ• <script> Ğ¸Ğ· Ğ²ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ HTML Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼
  container.querySelectorAll('script').forEach(oldScript => {
    const newScript = document.createElement('script');
    // ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚Ñ‹
    [...oldScript.attributes].forEach(a => newScript.setAttribute(a.name, a.value));
    newScript.textContent = oldScript.textContent;
    document.body.appendChild(newScript);      // Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
    oldScript.remove();                        // ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ Â«Ğ¼ĞµÑ€Ñ‚Ğ²Ñ‹Ğ¹Â» Ñ‚ĞµĞ³
  });

  document.dispatchEvent(new CustomEvent('supabase-ready', { detail: { supabase } }));
}


/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ„Ğ¾Ñ€Ğ¼Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
document.getElementById('req-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  try {
    const fileInput = document.getElementById('ts-file');
    const prompt    = document.getElementById('prompt').value.trim();
    if (!fileInput.files.length) return alert('ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ğ¢Ğ—');

    /* 1. ÑĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ 400â€¯ĞµĞ´. */
    const uid = (await supabase.auth.getUser()).data.user.id;
    const { data: newBal, error: billErr } =
          await supabase.rpc('charge_balance', { p_uid: uid, p_amount: 400 });

    if (billErr)      throw new Error(billErr.message);
    if (newBal === null)
      return alert('ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑ€ĞµĞ´ÑÑ‚Ğ² (Ğ½ÑƒĞ¶Ğ½Ğ¾ 400)');

    window.refreshBalance?.();                   // ÑÑ€Ğ°Ğ·Ñƒ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼

    /* 2. Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» */
    const file      = fileInput.files[0];
    const filename  = `${crypto.randomUUID()}_${file.name}`;
    const { error: upErr } = await supabase
      .storage.from('user-uploads')
      .upload(filename, file, { upsert:false });

    if (upErr) throw new Error(upErr.message);
    const filePath = filename;                   // Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚

    /* 3. Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ² service_requests */
    setStatus('Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°â€¦');
    const { data: reqRow, error: insErr } = await supabase
      .from('service_requests')
      .insert({ user_id:uid, service_no:1, prompt, file_path:filePath })
      .select('*').single();

    if (insErr) throw new Error('insert: ' + insErr.message);
    if (!reqRow) throw new Error('RLS Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ INSERT');

    /* 4. Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ GPT */
    let fileText = '';
    try {
      fileText = await file.text();
      if (fileText.length > 12_000)
        fileText = fileText.slice(0, 12_000) + ' â€¦[Ğ¾Ğ±Ñ€ĞµĞ·Ğ°Ğ½Ğ¾]';
    } catch { /* Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ */ }

    /* 5. Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ĞºÂ OpenAI */
    setStatus('ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° GPTÂ â€” Ğ¶Ğ´Ñ‘Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚â€¦');
    const gptBody = {
      model:'gpt-4o-mini',
      temperature:0.2,
      messages:[
        { role:'system',
          content:'Ğ¢Ñ‹ Ğ¸Ğ½Ğ¶ĞµĞ½ĞµÑ€â€‘ÑĞ¼ĞµÑ‚Ñ‡Ğ¸Ğº. Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ CSVâ€‘Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Â Ğ¢Ğ—.' },
        { role:'user',
          content:`Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ: Â«${prompt}Â»\n\nĞ¤Ğ°Ğ¹Ğ» (Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚):\n${fileText}` }
      ]
    };

    const gpt = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${window.OPENAI_KEY}`
      },
      body:JSON.stringify(gptBody)
    });

    if (!gpt.ok)
      throw new Error('OpenAIÂ HTTP ' + gpt.status + ': ' + await gpt.text());

    const { choices } = await gpt.json();
    const csvText = choices?.[0]?.message?.content || '';

    /* 6. ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ CSVâ€‘Ğ¾Ñ‚Ğ²ĞµÑ‚ */
    const resultPath = `${reqRow.id}.csv`;
    const { error: upResErr } = await supabase.storage.from('user-uploads')
      .upload(resultPath, new Blob([csvText], { type:'text/csv' }), { upsert:true });
    if (upResErr) throw new Error('upload result: ' + upResErr.message);

    /* 7. UPDATE ÑÑ‚Ñ€Ğ¾ĞºĞ¸ */
    const { error: updErr } = await supabase
      .from('service_requests')
      .update({ response_path:resultPath, status:'done' })
      .eq('id', reqRow.id);
    if (updErr) throw new Error('update: ' + updErr.message);

    setStatus('Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ âœ…');
    loadHistory();
    e.target.reset();
  } catch (err) {
    console.error(err);
    setStatus('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + err.message);
    // Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğµ Ğ½Ğ°Ğ´Ğ¾ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ´ĞµĞ½ÑŒĞ³Ğ¸?  â”€ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸; Ğ¿Ğ¾ĞºĞ° Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
  }
});

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
async function loadHistory() {
  const tbody = document.querySelector('#history tbody');
  tbody.innerHTML = '';

  const { data, error } = await supabase
    .from('service_requests')
    .select('id,created_at,prompt,response_path')
    .eq('service_no',1)
    .eq('user_id',(await supabase.auth.getUser()).data.user.id)
    .order('created_at',{ ascending:false });

  if (error) { console.error(error); return; }

  for (const row of data) {
    const pubUrl = row.response_path
      ? supabase.storage.from('user-uploads')
        .getPublicUrl(row.response_path).data.publicUrl
      : null;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border-t p-2">${new Date(row.created_at).toLocaleString()}</td>
      <td class="border-t p-2">${row.prompt.slice(0,70)}â€¦</td>
      <td class="border-t p-2">
        ${pubUrl ? `<a href="${pubUrl}" target="_blank"
                      class="underline text-blue-600">ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ</a>` : 'â€”'}
      </td>`;
    tbody.appendChild(tr);
  }
}

/*â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
function setStatus(t) {
  const el = document.getElementById('status');
  el.textContent = t;
  el.classList.remove('hidden');
}
</script>
